/*! Copyright (c) 2015 SlateScience and contributors | Licensed under the MIT license */
"use strict";!function(e,t){"undefined"!=typeof module&&module.exports?module.exports=t(require("angular")):"function"==typeof define&&define.amd?define(["angular"],t):t(e.angular)}(window,function(e){e.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache",function(e,t,n,r,l,i){var s=40,o=39,a=38,c=37,u=27,d=13,g=3,p=524288,h=500,m=200,f="autocomplete-required",v="Searching...",S="No results found",b="/angucomplete-alt/index.html";return i.put(b,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">  <input id="{{id}}_value" name={{inputName}} ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">    <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.subtitle && result.subtitle != \'\'" class="angucomplete-subtitle" ng-bind-html="result.subtitle"></div>      <div ng-if="!matchClass && result.subtitle && result.subtitle != \'\'" class="angucomplete-subtitle">{{result.subtitle}}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div></div>'),{restrict:"EA",require:"^?form",scope:{selectedObject:"=",disableInput:"=",initialValue:"=",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlRequestWithCredentials:"@",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",remoteApiHandler:"=",id:"@",type:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",subtitleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"@",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&",enterKeyPressed:"&",inputName:"@"},templateUrl:function(e,t){return t.templateUrl||b},link:function(t,i,b,w){function C(e){nt=null,t.hideResults(e),document.body.removeEventListener("click",C)}function R(e){return e.which?e.which:e.keyCode}function x(e){"function"==typeof t.selectedObject?t.selectedObject(e,t.currentIndex):t.selectedObject=e,U(e?!0:!1)}function y(e){return function(n){return t[e]?t[e](n):n}}function F(e){x({originalObject:e}),t.clearSelected&&(t.searchStr=null),L()}function $(e){return t.titleField.split(",").map(function(t){return D(e,t)}).join(" ")}function D(e,t){var n,r;if(t){n=t.split("."),r=e;for(var l=0;l<n.length;l++)r=r[n[l]]}else r=e;return r}function O(e,n){var l,i,s;return s=new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),e?(e.match&&e.replace||(e=e.toString()),i=e.match(s),l=i?e.replace(s,'<span class="'+t.matchClass+'">'+i[0]+"</span>"):e,r.trustAsHtml(l)):void 0}function U(e){t.notEmpty=e,X=t.searchStr,t.fieldRequired&&w&&w.$setValidity(Q,e)}function q(e){var n=R(e);if(n!==c&&n!==o)if(n===a||n===d)e.preventDefault();else if(n===s)e.preventDefault(),!t.showDropdown&&t.searchStr&&t.searchStr.length>=G&&(T(),t.searching=!0,K(t.searchStr));else if(n===u)L(),t.$apply(function(){B.val(t.searchStr)});else{if(0===G&&!t.searchStr)return;t.searchStr&&""!==t.searchStr?t.searchStr.length>=G&&(T(),J&&l.cancel(J),t.searching=!0,J=l(function(){K(t.searchStr)},t.pause)):t.showDropdown=!1,X&&X!==t.searchStr&&!t.clearSelected&&t.$apply(function(){x()})}}function j(e){!t.overrideSuggestions||t.selectedObject&&t.selectedObject.originalObject===t.searchStr||(e&&e.preventDefault(),F(t.searchStr))}function I(e){var n=R(e);n==d&&t.results&&(L(),t.enterKeyPressed())}function H(e){return function(n,r,l,i){r||l||i||(n=n.data),t.searching=!1,M(D(z(n),t.remoteUrlDataField),e)}}function k(e,n,r,l){n||r||l||(n=e.status),0!==n&&(t.remoteUrlErrorCallback?t.remoteUrlErrorCallback(e,n,r,l):console&&console.error&&console.error("http error"))}function E(){Z&&Z.resolve()}function N(r){var l={},i=t.remoteUrl+encodeURIComponent(r);t.remoteUrlRequestFormatter&&(l={params:t.remoteUrlRequestFormatter(r)},i=t.remoteUrl),t.remoteUrlRequestWithCredentials&&(l.withCredentials=!0),E(),Z=e.defer(),l.timeout=Z.promise,n.get(i,l).success(H(r)).error(k)}function A(n){E(),Z=e.defer(),t.remoteApiHandler(n,Z.promise).then(H(n))["catch"](k)}function L(){t.showDropdown=!1,t.results=[],et&&(et.scrollTop=0)}function T(){t.showDropdown=!0,t.currentIndex=-1,t.results=[]}function V(e){var n,r,l,i,s=t.searchFields.split(","),o=[];for(n=0;n<t.localData.length;n++){for(r=!1,l=0;l<s.length;l++)i=D(t.localData[n],s[l])||"",r=r||i.toString().toLowerCase().indexOf(e.toString().toLowerCase())>=0;r&&(o[o.length]=t.localData[n])}t.searching=!1,M(o,e)}function _(e,n,r){if(r)for(var l in n)if(n[l].toLowerCase()===r.toLowerCase())return void t.selectResult(e)}function K(e){!e||e.length<G||(t.localData?t.$apply(function(){V(e)}):t.remoteApiHandler?A(e):N(e))}function M(e,n){var r,l,i,s,o,a,c,u;if(e&&e.length>0)for(t.results=[],r=0;r<e.length;r++)t.titleField&&""!==t.titleField&&(o=a=$(e[r])),l="",i="",t.subtitleField&&(l=c=D(e[r],t.subtitleField)),t.descriptionField&&(i=u=D(e[r],t.descriptionField)),s="",t.imageField&&(s=D(e[r],t.imageField)),t.matchClass&&(a=O(o,n),c=O(l,n),u=O(i,n)),t.results[t.results.length]={title:a,subtitle:c,description:u,image:s,originalObject:e[r]},t.autoMatch&&_(t.results[t.results.length-1],{title:o,sub:l||"",des:i||""},t.searchStr);else t.results=[]}function P(){t.localData?M(t.localData,""):t.remoteApiHandler?A(""):N("")}var W,z,Y,B=i.find("input"),G=g,J=null,Q=f,X=null,Z=null,et=i[0].querySelector(".angucomplete-dropdown"),tt=!1,nt=null;i.on("mousedown",function(e){e.target.id?(nt=e.target.id,nt===t.id+"_dropdown"&&document.body.addEventListener("click",C)):nt=e.target.className}),t.currentIndex=null,t.searching=!1,Y=t.$watch("initialValue",function(e){e&&(Y(),"object"==typeof e?(t.searchStr=$(e),x({originalObject:e})):"string"==typeof e&&e.length>0?t.searchStr=e:console&&console.error&&console.error("Tried to set initial value of angucomplete to",e,"which is an invalid value"),U(!0))}),t.$on("angucomplete-alt:clearInput",function(e,n){n&&n!==t.id||(t.searchStr=null,x(),U(!1),L())}),t.onFocusHandler=function(){t.focusIn&&t.focusIn(),0!==G||t.searchStr&&0!==t.searchStr.length||(t.showDropdown=!0,P())},t.hideResults=function(){nt&&(nt===t.id+"_dropdown"||nt.indexOf("angucomplete")>=0)?nt=null:(W=l(function(){L(),t.$apply(function(){t.searchStr&&t.searchStr.length>0&&B.val(t.searchStr)})},m),E(),t.focusOut&&t.focusOut(),t.overrideSuggestions&&t.searchStr&&t.searchStr.length>0&&-1===t.currentIndex&&j())},t.resetHideResults=function(){W&&l.cancel(W)},t.hoverRow=function(e){t.currentIndex=e},t.selectResult=function(e){t.matchClass&&(e.title=$(e.originalObject),e.subtitle=D(e.originalObject,t.subtitleField),e.description=D(e.originalObject,t.descriptionField)),t.searchStr=t.clearSelected?null:e.title,x(e),L()},t.inputChangeHandler=function(e){return e.length<G?L():0===e.length&&0===G&&(t.searching=!1,P()),t.inputChanged&&(e=t.inputChanged(e)),e},t.fieldRequiredClass&&""!==t.fieldRequiredClass&&(Q=t.fieldRequiredClass),t.minlength&&""!==t.minlength&&(G=parseInt(t.minlength,10)),t.pause||(t.pause=h),t.clearSelected||(t.clearSelected=!1),t.overrideSuggestions||(t.overrideSuggestions=!1),t.fieldRequired&&w&&U(t.initialValue?!0:!1),t.inputType=b.type?b.type:"text",t.textSearching=b.textSearching?b.textSearching:v,t.textNoResults=b.textNoResults?b.textNoResults:S,t.maxlength=b.maxlength?b.maxlength:p,B.on("keydown",I),B.on("keyup",q),z=y("remoteUrlResponseFormatter"),t.$on("$destroy",function(){U(!0)}),l(function(){var e=getComputedStyle(et);tt=e.maxHeight&&"auto"===e.overflowY})}}}])});